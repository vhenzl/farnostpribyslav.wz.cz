# Zprávy data model and usage guide

Scope: read-only archive UI for “Zprávy” (news, articles). Focuses on two tables used by the feature: `tab_zpravy` and `tab_red_user`. Ignores comments and homepage pinning.

This document captures the actual schema and how the legacy PHP renders the data today, including non-obvious behaviors and file naming conventions for photos.

## Tables overview

- `tab_zpravy`: news articles, year-scoped ordering, optional photo gallery, and comment toggle.
- `tab_red_user`: redaction users; used to render who “published” an article (by ID reference from `tab_zpravy.vlozil`). Edit fields (`upravil`, `upravil_datum`) exist but are unfinished.


## `tab_zpravy` schema and semantics

Columns (from database.sql, with observed usage):

- `id` int(6) PK, AUTO_INCREMENT
  - Unique article ID across all years.
- `idr` tinyint(4) NOT NULL DEFAULT 0
  - Per-year ordinal used for navigation (prev/next) and ordering within a year.
  - Uniqueness is only meaningful in combination with `rok`.
  - Current code queries by year then `ORDER BY idr DESC`, and fetches a single item by `(rok, idr)`.
- `nazev` mediumtext NOT NULL
  - Title (plain text).
- `text` mediumtext NOT NULL
  - Article body, HTML allowed. Listing view shows an HTML-truncated excerpt; detail shows raw HTML.
  - Code strips a specific editor marker via regex: `<!-- Generated by XStandard ... -->`.
- `autor` mediumtext NOT NULL
  - Free-text byline shown as “Autor článku”. Not a foreign key; can contain arbitrary text.
- `datum` varchar(16) NOT NULL DEFAULT ''
  - Legacy human-readable timestamp (e.g., `10.2.2005 10:12`). Display is based on `datum_utc` instead; `datum` is legacy metadata.
- `foto_nazev` mediumtext NOT NULL
  - Photo slug used to build filenames for the article’s gallery. See Photo model below.
- `foto_pocet` tinyint(4) NOT NULL DEFAULT 0
  - Number of photos for the article. Drives the loop over photo files (1..N).
- `vlozil` smallint(4) NOT NULL DEFAULT 0
  - Foreign key (by convention) to `tab_red_user.id`. Used to render “Publikoval: …”.
- `upravil` int(11) DEFAULT NULL
  - Unfinished feature; intended FK to `tab_red_user.id`. Not used in rendering.
- `upravil_datum` varchar(16) DEFAULT NULL
  - Unfinished feature; legacy human-readable edit timestamp.
- `rok` smallint(6) NOT NULL DEFAULT 0
  - Article year used to scope listings and navigation. Authoritative for which year a zpráva belongs to; it may differ from `YEAR(datum_utc)`.
- `foto_popisek` mediumtext NOT NULL
  - Captions model for the photo gallery; see Photo model below.
- `showindex` tinyint(1) NOT NULL DEFAULT 0
  - Homepage pin flag. The sidebar displays the most recent pinned article via `SELECT * FROM tab_zpravy WHERE showindex = 1 ORDER BY id DESC LIMIT 1`.
- `komentar` int(1) unsigned DEFAULT 0
  - Comment toggle (0/1). When 1, the detail view renders the comments module. Business logic for comments is out of scope here.
- `datum_utc` datetime NOT NULL
  - Canonical timestamp used for date formatting in UI (day, month, year, weekday, time). Listing and detail derive display fields from this value.

Key behaviors and constraints observed in code (`_zpravy.php`):

- Listing (by year): `SELECT *, DATE_FORMAT(datum_utc, ...) FROM tab_zpravy WHERE rok = ? ORDER BY idr DESC`.
- Detail (by year + idr): `SELECT * FROM tab_zpravy WHERE idr = ? AND rok = ?` (with the same date-format projections).
- Navigation uses `MAX(idr)` within `rok` to determine the last article of the year; implicit minimum is 1.
- Displayed date/time comes from `datum_utc` using multiple `DATE_FORMAT` parts; weekday text is localized in PHP arrays.
- Excerpt in listing uses `xhtml_cut($text, 160)` after removing the XStandard marker.
- “Publikoval:” is resolved via `vlozil -> tab_red_user` (see user linkage below); “Autor článku:” is from the free-text `autor` column.

Alias vs. filter note:

- SQL often aliases `DATE_FORMAT(datum_utc, '%Y') AS rok` for year display. Filtering for year always uses the `rok` column, not the alias.
- SQL often aliases `rok AS rokzpravy` for logic related to the year of article.

Notes for the archive UI:

- Filter and group by `rok` (authoritative article year). Do not derive `rok` from `datum_utc`.
- Resolve “Publikoval:” by joining `vlozil` to `tab_red_user.id`.


## Photo model (foto_*)

The photo gallery for an article is defined by three fields: `foto_nazev`, `foto_pocet`, and `foto_popisek`. Files live in the repository’s `foto/` folder.

- File naming convention (as implemented in legacy PHP):
  - Path: `foto/{rokzpravy}_{foto_nazev}_{i}.jpg` where `i` is 1..`foto_pocet`.
  - Extension is always `.jpg` (hard-coded). Other formats are not supported by the current front-end.
  - Examples:
    - `foto/2001_bozitelo_1.jpg`
    - `foto/2004_cl-pust_3.jpg`
- `foto_nazev` is the shared slug for all files of an article. Avoid spaces; existing data use short lowercase slugs with hyphens/underscores.
- `foto_pocet` is the number of expected images. The UI renders exactly that many `<img>` tags; missing files will display as broken images in browsers.
- `foto_popisek` stores captions as a URL query-string style list of repeated parameters with the key `fp[]`, for example:
  - `&fp[]=Caption+1&fp[]=Caption+2&fp[]=Another+caption`
  - In PHP, the string is parsed via `parse_str($foto_popisek);` which creates an array variable `$fp` with zero-based indices.
  - Rendering uses `$fp[$i-1]` as both the `<img alt="...">` and the following `<h5>...</h5>` caption for the i-th photo.

Important quirks and edge cases:

- If `foto_popisek` is empty or contains fewer entries than `foto_pocet`, the code still renders images and uses an empty string for missing captions. This yields empty alt text and headings but no fatal error (just PHP notices in verbose modes).
- Captions may include non-ASCII characters and even HTML; data are stored in `utf8mb4`. Ensure the UI encodes `foto_popisek` correctly (use `http_build_query(['fp' => [ ... ]])`-style encoding when saving) and avoids double-escaping. The legacy code applies `stripslashes()` when outputting captions.
- The gallery only looks in the top-level `foto/` directory; there is no per-article subfolder.

Rendering notes for photos (read-only):

- Build image `src` using `rok` column (aka `rokzpravy`).
- Use index 1..`foto_pocet` for file numbering and map captions from `fp[]` as `$fp[$i-1]` semantics.
- Files are expected to be `.jpg`.


## `tab_red_user` schema and link usage

Columns (subset relevant to Zprávy):

- `id` int(11) PK, AUTO_INCREMENT
- `jmeno` varchar(50) NOT NULL
- `prijmeni` varchar(50) NOT NULL
- `email` varchar(50) NOT NULL
- `user_name`, `user_pass`, `prava`, `vychozi`, `cas1`, `cas2`, `IP1`, `IP2`, `admin`, `aktivace` … exist but are not used by the public Zprávy view.

How Zprávy resolves authorship today:

- `_autor.php` selects `SELECT * FROM tab_red_user ORDER BY id`, then builds two PHP arrays, `$inf_autor_jmeno[$i]` and `$inf_autor_email[$i]`, incrementing `$i` from 1 for each row.
- `_zpravy.php` then indexes those arrays using the `vlozil` (and potentially `upravil`) numeric values from `tab_zpravy` rows.

Quirk:

- This relies on the implicit assumption that `tab_red_user` IDs are contiguous starting from 1 and that array index `$i` equals `id`. If users are deleted or IDs are non-contiguous, this mapping breaks. In a modern UI, join on `tab_red_user.id` directly and avoid array-index addressing.

Rendering note for user linkage:

- For “Publikoval:”, join `tab_zpravy.vlozil = tab_red_user.id` and render `CONCAT(jmeno, ' ', prijmeni)` with `mailto:email`.
- The `upravil` fields are unfinished in the legacy app. They would be used for “Upravil:” by resolving `tab_zpravy.upravil` similarly and displaying `upravil_datum` if present.


## Date/time model and display

- Actual display pieces (weekday, day, month name, year, time) are derived from `datum_utc` via MySQL `DATE_FORMAT` in queries, with localized Czech weekday/month names supplied by PHP arrays.
- `rok` is used to scope listings and navigation. It is not required to match `YEAR(datum_utc)`.


## Known data encoding notes

- The dump declares `utf8mb4` (collation `utf8mb4_unicode_ci`). Some textual samples in the dump appear with broken diacritics (likely due to historical encoding mismatches). Ensure the UI consistently uses UTF‑8 and the DB connection collation matches the table definition.


## References in code

- Listing and detail: `_zpravy.php`
- User lookup arrays: `_autor.php`


---

This guide reflects the live behaviors in the current (legacy) PHP codebase.
